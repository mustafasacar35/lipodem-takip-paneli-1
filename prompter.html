<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompter + Kamera (Pro)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.08);
      --radius:14px;

      --sentA:#fef9c3;
      --sentB:#e5e7eb;
      --paren:#93c5fd;
      --quote:#a7f3d0;

      --guide: rgba(255,255,255,.55);

      /* Kullanıcı ayarları */
      --baseText: #e5e7eb;
      --sidePad: 64px;
      --topPad: 48px;

      /* Pro band */
      --bandTop: 38;      /* % */
      --bandBottom: 62;   /* % */
      --shadeAlpha: .55;  /* 0..0.85 */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      padding:16px;
      height:100vh;
      align-items:stretch;
    }

    .leftPanel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
      min-height:0;
    }

    textarea{
      width:100%;
      flex:1;
      min-height:240px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:12px;
      outline:none;
      line-height:1.4;
    }

    .rightCol{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
      min-height:0;
      height:100%;
    }

    .stage{
      position:relative;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:#000;
      overflow:hidden;
      min-width:0;
      min-height:0;
      flex:1;
    }

    /* Kamera */
    .cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
      z-index:0;
      background:#000;
    }
    .stage.camOn .cam{ display:block; }

    /* Scrollbar + içerik */
    .viewport{
      position:absolute;
      inset:0;
      padding: var(--topPad) var(--sidePad);
      overflow-y: scroll;
      overflow-x: hidden;
      scrollbar-gutter: stable;
      z-index:5;
    }
    .content{
      white-space: pre-wrap;
      font-size:42px;
      line-height:1.35;
      letter-spacing:.2px;
      text-shadow:0 2px 16px rgba(0,0,0,.45);
      color: var(--baseText);
    }

    .sentence.sA{ color: var(--sentA); }
    .sentence.sB{ color: var(--sentB); }
    .paren{ color: var(--paren); }
    .quote{ color: var(--quote); }
    .content strong{ font-weight: 800; }
    .content em{ font-style: italic; opacity: .95; }

    .mirror .content{
      transform: scaleX(-1);
      transform-origin: center;
    }

    .topbar{
      position:absolute;
      top:12px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      pointer-events:none;
      z-index:12;
    }
    .pill{
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    .pad{ height: 0px; }

    /* Perde */
    .glass{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:4;
      background:rgba(0,0,0,.25);
      transition:opacity .12s ease;
    }
    .stage.glassOn .glass{ opacity:1; }

    /* Pro band */
    .bandShade{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      z-index:6;
      transition:opacity .12s ease;
      background:
        linear-gradient(to bottom,
          rgba(0,0,0,var(--shadeAlpha)) 0%,
          rgba(0,0,0,var(--shadeAlpha)) calc(var(--bandTop) * 1%),
          rgba(0,0,0,0)               calc(var(--bandTop) * 1%),
          rgba(0,0,0,0)               calc(var(--bandBottom) * 1%),
          rgba(0,0,0,var(--shadeAlpha)) calc(var(--bandBottom) * 1%),
          rgba(0,0,0,var(--shadeAlpha)) 100%);
    }
    .bandFrame{
      position:absolute;
      left:0;
      right:0;
      top:50%;
      height:20%;
      pointer-events:none;
      opacity:0;
      z-index:7;
      transition:opacity .12s ease;
      border-top:1px solid rgba(255,255,255,.22);
      border-bottom:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 22px rgba(255,255,255,.10) inset;
      background: linear-gradient(to bottom, rgba(255,255,255,.045), rgba(255,255,255,0));
    }
    .stage.bandOn .bandShade,
    .stage.bandOn .bandFrame{ opacity:1; }

    /* Vignette */
    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
      z-index:8;
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,0) 30%,
          rgba(0,0,0,.35) 70%,
          rgba(0,0,0,.70) 100%);
    }
    .stage.vignetteOn .vignette{ opacity:1; }

    /* Okuma çizgisi */
    .guideLine{
      position:absolute;
      left:0;
      right:0;
      top:50%;
      height:3px;
      background:var(--guide);
      box-shadow: 0 0 18px rgba(255,255,255,.28);
      opacity:0;
      transition: opacity .12s ease;
      pointer-events:none;
      z-index:9;
    }
    .stage.guideOn .guideLine{ opacity:1; }

    /* ✅ Mini kontrol barı (ayarlar gizliyken/tam ekranda) */
    .miniControls{
      position:absolute;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:13;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      pointer-events:auto;
      padding:10px;
      border-radius:12px;
      background:rgba(0,0,0,.48);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
      opacity:0;
      transform: translateY(8px);
      transition: opacity .12s ease, transform .12s ease;
    }
    body.settingsHidden .miniControls{ opacity:1; transform: translateY(0); }
    .stage:fullscreen .miniControls{ opacity:1; transform: translateY(0); }

    .miniLeft,.miniRight{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .miniControls .miniVal{ color:var(--muted); font-size:12px; }

    /* ✅ Alt ayarlar paneli */
    .settings{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    body.settingsHidden .settings{ display:none; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row label{
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:8px;
      align-items:center;
      white-space:nowrap;
      user-select:none;
    }

    input[type="range"]{ width:220px; }
    input[type="color"]{
      width:44px;
      height:34px;
      border:none;
      background:transparent;
      padding:0;
    }
    select{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      outline:none;
    }
    .val{
      font-variant-numeric:tabular-nums;
      color:var(--text);
      opacity:.9;
    }
    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.12s;
      user-select:none;
    }
    button:hover{ border-color:rgba(255,255,255,.18); }
    button.primary{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.35);
    }
    button.danger{
      background:rgba(248,113,113,.14);
      border-color:rgba(248,113,113,.28);
    }
    button.small{
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
    }
    .hint{ color:var(--muted); font-size:12px; line-height:1.35; }

    a.dl{
      color:#c7d2fe;
      text-decoration:none;
      border:1px solid rgba(199,210,254,.25);
      padding:8px 10px;
      border-radius:10px;
      display:none;
    }
    a.dl.show{ display:inline-flex; }

    /* Tam ekran */
    .stage:fullscreen{
      border-radius:0;
      border:none;
    }
    .stage:fullscreen .viewport{
      padding: 72px 32px;
    }

    /* ✅ Mobil: stage’in görünmesi garanti */
    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        height:auto;
      }
      .rightCol{ order:1; }
      .leftPanel{ order:2; }

      :root{
        --sidePad: 18px;
        --topPad: 24px;
      }

      .stage{
        flex:none;
        height: 58vh;     /* ✅ prompter + kamera kesin görünür */
        min-height: 320px;
      }

      body.settingsHidden .stage{
        height: 82vh;     /* ✅ ayarlar gizliyken daha büyük */
      }

      .settings{
        max-height: 44vh;
        overflow:auto;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- SOL: Metin girişi -->
    <div class="leftPanel">
      <div class="row" style="justify-content:space-between;">
        <strong>Metin</strong>
        <span class="hint">Metni buraya yapıştır</span>
      </div>
      <textarea id="input" placeholder="Metni buraya yapıştır..."></textarea>
      <div class="hint">iPhone’da kamera için sayfayı HTTPS üzerinden açmalısın.</div>
    </div>

    <!-- SAĞ: Prompter + Alt ayarlar -->
    <div class="rightCol">
      <div class="stage" id="stage">
        <div class="topbar">
          <div class="pill" id="statusPill">Hazır</div>
          <div class="pill" id="posPill">0%</div>
        </div>

        <video id="cam" class="cam" playsinline muted></video>

        <div class="glass"></div>
        <div class="bandShade"></div>
        <div class="bandFrame" id="bandFrame"></div>
        <div class="vignette"></div>
        <div class="guideLine" id="guideLine"></div>

        <div class="viewport" id="viewport">
          <div class="pad" id="padTop"></div>
          <div class="content" id="content"></div>
          <div class="pad" id="padBottom"></div>
        </div>

        <!-- ✅ Mini kontroller (ayarlar gizliyken/tam ekranda) -->
        <div class="miniControls" id="miniControls">
          <div class="miniLeft">
            <button id="miniPlay" class="small primary">Başlat</button>
            <button id="miniPause" class="small">Duraklat</button>
            <button id="miniStop" class="small danger">Durdur</button>
          </div>
          <div class="miniRight">
            <button id="miniSlow" class="small">Hız −</button>
            <span class="miniVal" id="miniSpeedVal">80</span>
            <button id="miniFast" class="small">Hız +</button>
            <button id="miniCam" class="small">Kamera</button>
            <button id="miniSettings" class="small">Ayarlar</button>
          </div>
        </div>
      </div>

      <!-- Ayarlar -->
      <div class="settings" id="settings">
        <div class="row" style="justify-content:space-between;">
          <strong>Ayarlar</strong>
          <div class="row">
            <button id="toggleSettings" class="small">Ayarları Gizle</button>
            <button id="fsBtn" class="small">Tam ekran</button>
          </div>
        </div>

        <div class="row">
          <button id="startBtn" class="primary">Başlat</button>
          <button id="pauseBtn">Duraklat</button>
          <button id="stopBtn" class="danger">Durdur</button>
        </div>

        <div class="row">
          <label>
            Hız
            <input id="speed" type="range" min="0" max="300" step="1" value="80" />
            <span class="val" id="speedVal">80 px/sn</span>
          </label>
          <label>
            Yazı
            <input id="fontSize" type="range" min="20" max="80" step="1" value="42" />
            <span class="val" id="fontVal">42 px</span>
          </label>
        </div>

        <div class="row">
          <label>
            Yan boşluk
            <input id="sidePad" type="range" min="8" max="120" step="1" value="64" />
            <span class="val" id="sidePadVal">64 px</span>
          </label>
        </div>

        <!-- Yazı rengi -->
        <div class="row">
          <label>
            Yazı rengi (Hue)
            <input id="hue" type="range" min="0" max="360" step="1" value="210"
                   style="width:220px;background:linear-gradient(90deg, red, yellow, lime, cyan, blue, magenta, red);border-radius:999px;height:8px;appearance:none;" />
            <span class="val" id="hueVal">210</span>
          </label>

          <label>
            Seç
            <input id="colorPick" type="color" value="#e5e7eb" />
            <span class="val" id="colorVal">#e5e7eb</span>
          </label>
        </div>

        <div class="row">
          <label><input id="altSent" type="checkbox" /> Cümleleri iki renk</label>
          <label><input id="parenOn" type="checkbox" /> Parantez mavi</label>
          <label><input id="quoteOn" type="checkbox" /> Tırnak içi renk</label>
          <label><input id="mdOn" type="checkbox" /> **Kalın** / *İtalik*</label>
          <label><input id="mirror" type="checkbox" /> Ayna</label>
        </div>

        <div class="row">
          <label><input id="vignetteOn" type="checkbox" /> Vignette</label>
          <label><input id="guideOn" type="checkbox" /> Okuma çizgisi</label>
          <label><input id="glassOn" type="checkbox" /> Okunurluk perdesi</label>
          <label><input id="bandOn" type="checkbox" /> Okuma bandı</label>
          <label><input id="proMode" type="checkbox" /> Pro Mod</label>
        </div>

        <div class="row">
          <label>
            Çizgi konumu
            <input id="guidePos" type="range" min="10" max="90" step="1" value="50" />
            <span class="val" id="guidePosVal">%50</span>
          </label>
          <label>
            Kalınlık
            <input id="guideThick" type="range" min="1" max="10" step="1" value="3" />
            <span class="val" id="guideThickVal">3 px</span>
          </label>
        </div>

        <div class="row">
          <label>
            Band yüksekliği
            <input id="bandH" type="range" min="10" max="50" step="1" value="24" />
            <span class="val" id="bandHVal">%24</span>
          </label>
          <label>
            Dış karartma
            <input id="bandShade" type="range" min="0" max="85" step="1" value="55" />
            <span class="val" id="bandShadeVal">%55</span>
          </label>
        </div>

        <div class="row">
          <label><input id="camOn" type="checkbox" /> Kamera</label>
          <label>Yön:
            <select id="camFacing">
              <option value="user">Ön</option>
              <option value="environment">Arka</option>
            </select>
          </label>
          <label><input id="camAudio" type="checkbox" checked /> Ses</label>
          <button id="recBtn">Kayıt Başlat</button>
          <a id="dl" class="dl" href="#" download="kayit.webm">Kaydı indir</a>
          <button id="shareBtn" style="display:none;">Paylaş</button>
        </div>

        <div class="row">
          <button id="holdUp" class="small">▲ Yukarı (basılı tut)</button>
          <button id="holdDown" class="small">▼ Aşağı (basılı tut)</button>
          <span class="hint">Space: Duraklat • ↑↓: sar • ←→: hız • iPhone’da mini bar kullan</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById('input');
    const viewport = document.getElementById('viewport');
    const stage = document.getElementById('stage');
    const camEl = document.getElementById('cam');

    const padTop = document.getElementById('padTop');
    const padBottom = document.getElementById('padBottom');
    const content = document.getElementById('content');

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const fsBtn = document.getElementById('fsBtn');
    const toggleSettingsBtn = document.getElementById('toggleSettings');

    const speed = document.getElementById('speed');
    const speedVal = document.getElementById('speedVal');

    const fontSize = document.getElementById('fontSize');
    const fontVal = document.getElementById('fontVal');

    const sidePad = document.getElementById('sidePad');
    const sidePadVal = document.getElementById('sidePadVal');

    const hue = document.getElementById('hue');
    const hueVal = document.getElementById('hueVal');
    const colorPick = document.getElementById('colorPick');
    const colorVal = document.getElementById('colorVal');

    const altSent = document.getElementById('altSent');
    const parenOn = document.getElementById('parenOn');
    const quoteOn = document.getElementById('quoteOn');
    const mdOn = document.getElementById('mdOn');
    const mirror = document.getElementById('mirror');

    const vignetteOn = document.getElementById('vignetteOn');
    const guideOn = document.getElementById('guideOn');
    const guidePos = document.getElementById('guidePos');
    const guidePosVal = document.getElementById('guidePosVal');
    const guideThick = document.getElementById('guideThick');
    const guideThickVal = document.getElementById('guideThickVal');
    const guideLine = document.getElementById('guideLine');
    const glassOn = document.getElementById('glassOn');

    const proMode = document.getElementById('proMode');
    const bandOn = document.getElementById('bandOn');
    const bandH = document.getElementById('bandH');
    const bandHVal = document.getElementById('bandHVal');
    const bandShade = document.getElementById('bandShade');
    const bandShadeVal = document.getElementById('bandShadeVal');
    const bandFrame = document.getElementById('bandFrame');

    const camOn = document.getElementById('camOn');
    const camFacing = document.getElementById('camFacing');
    const camAudio = document.getElementById('camAudio');
    const recBtn = document.getElementById('recBtn');
    const dl = document.getElementById('dl');
    const shareBtn = document.getElementById('shareBtn');

    const statusPill = document.getElementById('statusPill');
    const posPill = document.getElementById('posPill');

    // Mini bar
    const miniPlay = document.getElementById('miniPlay');
    const miniPause = document.getElementById('miniPause');
    const miniStop = document.getElementById('miniStop');
    const miniSlow = document.getElementById('miniSlow');
    const miniFast = document.getElementById('miniFast');
    const miniCam = document.getElementById('miniCam');
    const miniSettings = document.getElementById('miniSettings');
    const miniSpeedVal = document.getElementById('miniSpeedVal');

    let rafId = null;
    let running = false;
    let paused = false;

    let manualDir = 0;
    const manualSpeed = 420;
    let lastTs = 0;

    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let lastBlob = null;

    function setStatus(t){ statusPill.textContent = t; }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[ch]));
    }

    function hslToHex(h, s=35, l=90){
      s /= 100; l /= 100;
      const c = (1 - Math.abs(2*l - 1)) * s;
      const x = c * (1 - Math.abs(((h/60) % 2) - 1));
      const m = l - c/2;
      let r=0,g=0,b=0;
      if (0<=h && h<60) { r=c; g=x; b=0; }
      else if (60<=h && h<120){ r=x; g=c; b=0; }
      else if (120<=h && h<180){ r=0; g=c; b=x; }
      else if (180<=h && h<240){ r=0; g=x; b=c; }
      else if (240<=h && h<300){ r=x; g=0; b=c; }
      else { r=c; g=0; b=x; }
      const toHex = v => Math.round((v+m)*255).toString(16).padStart(2,'0');
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    function updateBandVars(){
      const pos = Number(guidePos.value);
      const h = Number(bandH.value);
      const top = clamp(pos - (h/2), 0, 100);
      const bottom = clamp(pos + (h/2), 0, 100);

      const shadePct = Number(bandShade.value);
      const alpha = clamp(shadePct / 100, 0, 0.85);

      stage.style.setProperty('--bandTop', String(top));
      stage.style.setProperty('--bandBottom', String(bottom));
      stage.style.setProperty('--shadeAlpha', String(alpha));

      bandFrame.style.top = `${top}%`;
      bandFrame.style.height = `${bottom - top}%`;
    }

    function updatePadding(){
      const h = viewport.clientHeight;
      padTop.style.height = `${h}px`;
      padBottom.style.height = `${h}px`;
    }

    function maxScroll(){
      return Math.max(0, viewport.scrollHeight - viewport.clientHeight);
    }

    function updateProgress(){
      const m = maxScroll();
      const pct = m ? (viewport.scrollTop / m) * 100 : 0;
      posPill.textContent = `${clamp(pct,0,100).toFixed(0)}%`;
    }

    function updateUI(){
      speedVal.textContent = `${speed.value} px/sn`;
      fontVal.textContent = `${fontSize.value} px`;
      content.style.fontSize = `${fontSize.value}px`;

      sidePadVal.textContent = `${sidePad.value} px`;
      stage.style.setProperty('--sidePad', `${sidePad.value}px`);

      stage.classList.toggle('mirror', mirror.checked);
      stage.classList.toggle('vignetteOn', vignetteOn.checked);
      stage.classList.toggle('guideOn', guideOn.checked);
      stage.classList.toggle('glassOn', glassOn.checked);
      stage.classList.toggle('bandOn', bandOn.checked);
      stage.classList.toggle('camOn', camOn.checked);

      guidePosVal.textContent = `%${guidePos.value}`;
      guideThickVal.textContent = `${guideThick.value} px`;
      guideLine.style.top = `${guidePos.value}%`;
      guideLine.style.height = `${guideThick.value}px`;

      bandHVal.textContent = `%${bandH.value}`;
      bandShadeVal.textContent = `%${bandShade.value}`;
      updateBandVars();

      hueVal.textContent = hue.value;
      colorVal.textContent = colorPick.value;
      stage.style.setProperty('--baseText', colorPick.value);

      pauseBtn.textContent = paused ? 'Devam' : 'Duraklat';
      miniSpeedVal.textContent = speed.value;

      toggleSettingsBtn.textContent = document.body.classList.contains('settingsHidden') ? 'Ayarları Göster' : 'Ayarları Gizle';
    }

    function splitSentencesKeepingSpaces(text){
      const re = /[^.!?…]+[.!?…]*\s*/g;
      const parts = text.match(re);
      return parts && parts.length ? parts : [text];
    }

    function applyMarkdown(s){
      s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
      s = s.replace(/\*(?!\*)([^*]+?)\*/g, "<em>$1</em>");
      return s;
    }
    function applyParen(s){
      return s.replace(/\([^)]*\)/g, m => `<span class="paren">${m}</span>`);
    }
    function applyQuotes(s){
      s = s.replace(/"([^"]+)"/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/'([^']+)'/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/“([^”]+)”/g, m => `<span class="quote">${m}</span>`);
      s = s.replace(/‘([^’]+)’/g, m => `<span class="quote">${m}</span>`);
      return s;
    }

    function renderText(){
      const text = input.value || "";
      if (!text.trim()){
        content.textContent = "Metin burada görünecek…";
        return;
      }

      const useAlt = altSent.checked;
      const useParenOpt = parenOn.checked;
      const useQuoteOpt = quoteOn.checked;
      const useMd = mdOn.checked;

      if (!useAlt && !useParenOpt && !useQuoteOpt && !useMd){
        content.textContent = text;
        return;
      }

      const segs = splitSentencesKeepingSpaces(text);
      let html = "";

      for (let i = 0; i < segs.length; i++){
        let s = escapeHtml(segs[i]);

        if (useMd) s = applyMarkdown(s);
        if (useParenOpt) s = applyParen(s);
        if (useQuoteOpt) s = applyQuotes(s);

        if (useAlt){
          const cls = (i % 2 === 0) ? "sA" : "sB";
          html += `<span class="sentence ${cls}">${s}</span>`;
        } else {
          html += s;
        }
      }

      content.innerHTML = html;
    }

    function preview(){
      renderText();
      updatePadding();
      viewport.scrollTop = viewport.clientHeight;
      setStatus('Hazır');
      updateProgress();
    }

    function ensureLoop(){
      if (rafId) return;
      lastTs = 0;
      rafId = requestAnimationFrame(tick);
    }

    function stopLoopIfIdle(){
      if (running || manualDir !== 0) return;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      lastTs = 0;
    }

    function tick(ts){
      if (!rafId) return;

      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      let delta = 0;
      if (running && !paused) delta += Number(speed.value) * dt;
      if (manualDir !== 0) delta += manualDir * manualSpeed * dt;

      if (delta !== 0){
        const m = maxScroll();
        const next = clamp(viewport.scrollTop + delta, 0, m);
        viewport.scrollTop = next;
        updateProgress();

        if (running && !paused && delta > 0 && next >= m - 1){
          running = false;
          paused = false;
          setStatus('Bitti');
          updateUI();
          stopLoopIfIdle();
          return;
        }
      }

      if (running || manualDir !== 0) rafId = requestAnimationFrame(tick);
      else stopLoopIfIdle();
    }

    function start(){
      renderText();
      updatePadding();

      if (!input.value.trim()){
        setStatus('Metin boş');
        content.textContent = "Metin burada görünecek…";
        posPill.textContent = "0%";
        return;
      }

      viewport.scrollTop = 0;
      running = true;
      paused = false;
      setStatus('Oynatılıyor');
      updateUI();
      updateProgress();
      ensureLoop();
    }

    function togglePause(){
      if (!running) return;
      paused = !paused;
      setStatus(paused ? 'Duraklatıldı' : 'Oynatılıyor');
      updateUI();
      ensureLoop();
    }

    function stop(){
      running = false;
      paused = false;
      manualDir = 0;
      setStatus('Durduruldu');
      updateUI();
      preview();
      stopLoopIfIdle();
    }

    function adjustSpeed(delta){
      const v = Number(speed.value);
      speed.value = String(clamp(v + delta, Number(speed.min), Number(speed.max)));
      updateUI();
    }

    async function toggleFullscreen(){
      try{
        if (!document.fullscreenElement) await stage.requestFullscreen();
        else await document.exitFullscreen();
      }catch(e){ console.warn(e); }
      updateUI();
    }

    function applyProPreset(){
      bandOn.checked = true;
      vignetteOn.checked = true;
      guideOn.checked = true;
      glassOn.checked = true;

      guidePos.value = "45";
      guideThick.value = "2";
      bandH.value = "24";
      bandShade.value = "55";

      if (window.matchMedia("(max-width: 980px)").matches){
        sidePad.value = "18";
      }
      updateUI();
    }

    // Kamera
    async function startCamera(){
      try{
        await stopCamera();
        const constraints = {
          video: { facingMode: camFacing.value },
          audio: camAudio.checked
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        camEl.srcObject = stream;
        await camEl.play();
        setStatus('Kamera açık');
      }catch(err){
        console.error(err);
        setStatus('Kamera açılamadı (HTTPS + izin)');
        camOn.checked = false;
        updateUI();
      }
    }

    async function stopCamera(){
      if (mediaRecorder && mediaRecorder.state !== 'inactive'){
        try{ mediaRecorder.stop(); }catch(_){}
      }
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      camEl.srcObject = null;
    }

    // Ayarlar gizle/göster
    function toggleSettings(){
      document.body.classList.toggle('settingsHidden');
      updateUI();
      // iPhone'da yükseklik değişince padding’i güncelle
      setTimeout(() => { updatePadding(); updateProgress(); }, 50);
    }

    // --- Eventler ---
    startBtn.addEventListener('click', start);
    pauseBtn.addEventListener('click', togglePause);
    stopBtn.addEventListener('click', stop);
    fsBtn.addEventListener('click', toggleFullscreen);
    toggleSettingsBtn.addEventListener('click', toggleSettings);

    // Mini bar
    miniPlay.addEventListener('click', start);
    miniPause.addEventListener('click', togglePause);
    miniStop.addEventListener('click', stop);
    miniSlow.addEventListener('click', () => adjustSpeed(-5));
    miniFast.addEventListener('click', () => adjustSpeed(+5));
    miniCam.addEventListener('click', async () => {
      camOn.checked = !camOn.checked;
      updateUI();
      if (camOn.checked){
        if (proMode.checked) applyProPreset();
        await startCamera();
      } else {
        await stopCamera();
      }
    });
    miniSettings.addEventListener('click', toggleSettings);

    document.addEventListener('fullscreenchange', () => updateUI());

    speed.addEventListener('input', updateUI);
    fontSize.addEventListener('input', () => { updateUI(); updatePadding(); });
    sidePad.addEventListener('input', updateUI);

    hue.addEventListener('input', () => {
      const hex = hslToHex(Number(hue.value), 35, 90);
      hueVal.textContent = hue.value;
      colorPick.value = hex;
      colorVal.textContent = hex;
      stage.style.setProperty('--baseText', hex);
    });

    colorPick.addEventListener('input', () => {
      colorVal.textContent = colorPick.value;
      stage.style.setProperty('--baseText', colorPick.value);
    });

    [altSent, parenOn, quoteOn, mdOn].forEach(el => {
      el.addEventListener('change', () => { renderText(); updatePadding(); updateProgress(); });
    });
    [mirror, vignetteOn, guideOn, glassOn, bandOn].forEach(el => el.addEventListener('change', updateUI));
    [guidePos, guideThick, bandH, bandShade].forEach(el => el.addEventListener('input', updateUI));

    proMode.addEventListener('change', () => {
      if (proMode.checked) applyProPreset();
      updateUI();
    });

    input.addEventListener('input', () => {
      if (!running) preview();
      else {
        const keep = viewport.scrollTop;
        renderText();
        updatePadding();
        viewport.scrollTop = clamp(keep, 0, maxScroll());
        updateProgress();
      }
    });

    viewport.addEventListener('scroll', () => updateProgress(), { passive:true });

    function bindHold(btn, dir){
      const startHold = (e) => { e.preventDefault(); manualDir = dir; ensureLoop(); };
      const stopHold = () => { manualDir = 0; stopLoopIfIdle(); };
      btn.addEventListener('pointerdown', startHold);
      btn.addEventListener('pointerup', stopHold);
      btn.addEventListener('pointercancel', stopHold);
      btn.addEventListener('pointerleave', stopHold);
    }
    bindHold(document.getElementById('holdUp'), -1);
    bindHold(document.getElementById('holdDown'), +1);

    camOn.addEventListener('change', async () => {
      updateUI();
      if (camOn.checked){
        if (proMode.checked) applyProPreset();
        await startCamera();
      } else {
        await stopCamera();
      }
    });
    camFacing.addEventListener('change', async () => { if (camOn.checked) await startCamera(); });
    camAudio.addEventListener('change', async () => {
      if (camOn.checked && (!mediaRecorder || mediaRecorder.state === 'inactive')) await startCamera();
    });

    window.addEventListener('resize', () => { updatePadding(); updateUI(); updateProgress(); });

    // İlk durum
    updateUI();
    preview();
  </script>
</body>
</html>
